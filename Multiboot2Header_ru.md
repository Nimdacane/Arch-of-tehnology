# Спецификая Multiboot2. Заголовок исполняемого файла
> [!WARNING]
> ВНИМАНИЕ! 
> 1. Если вы видите в описании ***Потом***, свяжитесь с создателем который забыл сделать описание
> 2. Данная документация состоит из *"Устаревших"* данных - новые части заголовка **пока что** проигнорированны(например новые архитектуры EFI x86_64(amd64) в поле Architecture по смещению 4(ведь тег EFI AMD64 Entry Point указан в документации) и подобные части/теги/спецификации) 
> *(Но надо учесть что на добавлены только новые параметры/теги, сама структура заголовка не подверженна измениям)*

### Главный заголовок
| Смещение             | Тип   | Имя           | Примечание   | Значение          | Описание                                                                                                                                |
|----------------------|-------|---------------|--------------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| 0                    |  u32  | MAGIC         | обязательный | 0xE85250D6        | Индентификатор заголовка Multiboot2, всегда 0xE85250D6                                                                                  |
| 4                    |  u32  | Architecture  | обязательный | 0                 | Архитектура набора команд центрального процессора, поскольку magic не палиндром - направление байт (LE/BE) не указывается в архитектуре |
| 8                    |  u32  | Header length | обязательный | (Всегда разное)   | Указывается длина заголовка Multiboot2 в байтах, включая магические поля.                                                               |
| 12                   |  u32  | Checksum      | обязательный | (Всегда разное)   | Проверочная сумма(CRC32), которая при сумме со значениями MAGIC, Architecture и Header length дает 32-х битный ноль                     |
| 16-XX                | [Tag] | Tags...       | обязательный | Массив            | Теги Multiboot2                                                                                                                         |
| XX-КонецЗаголовка    | Tag   | 0/8 тег       | обязательный | (0/8 тег)         | Тег Multiboot2, имеющий тип 0 и размер 8, закрывает все теги                                                                            |

---
## Таблицы

### Типы
| Название | Количество бит | Количество байт | Знаковость | Использование  |
|----------|----------------|-----------------|------------|----------------|
| u8       | 8              | 1               | нет знака  | Число          |
| u16      | 16             | 2               | нет знака  | Число          | 
| u32      | 32             | 4               | нет знака  | Число          |
| u64      | 64             | 8               | нет знака  | Число          |
| Tag      | >8             | >1              | нет знака  | Тег Multiboot2 |

---
### Заголовок тега
Такой заголовок имеет каждый тег в начале
| Тип | Имя           | Значение                   | Описание    |
|-----|---------------|----------------------------|-------------|
| u16 | Type          | 0-10                       | Тип тега    |
| u16 | Flags         | (2 байта побитовых флагов) | Флаги тега. "Если установлен бит «0» (также известном как «optional»), загрузчик может проигнорировать этот тег, если он не поддерживается"       |
| u32 | Size          | (4 байта размера тега)     | Размер тега                   |
|     | Data          | (Остальные данные тега)    | Данные тега, заканчивающиеся по достижению размера тега |

---
### Теги

#### Таблица типов тегов
> [!WARNING] 
> Примечание!
> Все указанные ниже теги будут подробно рассмотрены ниже

| Тег | ID типа | Описание |
|--|--|--|
| [Information Request Tag](#information-request-tag) | 1 | Тег, для запрашивания данных от Mutliboot2-совместимого загрузчика |
| [Multiboot2 Address Tag](#multiboot2-address-tag) | 2 | Settings тег, который задает физические адреса загрузки Multiboot2-совместимого приложения/ОС/ядра |
| [Multiboot2 Entry Address Tag](#multiboot2-entry-address-tag) | 3 | Settings тег, задающий физический адрес на который должен грузиться Multiboot2-совместимый загрузчик |
| [Flags Tag](#flags-tag) | 4 | Тег, который задает "Консольные флаги". Имеет фиксированный размер 12 |
| [Framebuffer Tag](#framebuffer-tag) | 5 | Settings тег, который задает ***предпочтительный*** графический режим *буффера кадров*(framebuffer). Имеет фиксированный размер 20 |
| [Module Alligment Tag](#module-alligment-tag) | 6 | Тег, требующий выровнять модули по странице. Имеет фиксированный размер 8 |
| [EFI Boot Services Tag](#efi-boot-services-tag) | 7 | Settings тег, указывающий на то что ОС/приложение/ядро поддерживает запуск без выхода из EFI Boot Services. Имеет фиксированный размер 8 |
| [Multiboot2 EFI i386 Entry Address Tag](#multiboot2-efi-i386-entry-address-tag) | 8 | Settings тег, задающий физический адрес на который должен грузиться Multiboot2-совместимый загрузчик при архитектуре *UEFI/EFI **i386*** |
| [Multiboot2 EFI amd64 Entry Address Tag](#multiboot2-efi-amd64-entry-address-tag) | 9 | Settings тег, задающий физический адрес на который должен грузиться Multiboot2-совместимый загрузчик при архитектуре *UEFI/EFI **amd64*** |
| [Relocatable Tag](#relocatable-tag) | 10 | Тег, указывающий на возможность перемещения образа ОС/ядра/приложения. Имеет фиксированный размер 24|
| [End Tag](#end-tag) | 0 | Тег, закрывающий массив тегов Multiboot2. Имеет фиксированный размер 8 |

> *Settings тег - тег, настраивающий загрузку ОС/ядра/приложения*

---
#### Подробное описание тегов
> [!WARNING]
> Внимание!
> В таблицах ниже указаны **только** измененное поле Type и иногда (при фиксированном размере) размер тега, а также остальные данные тега (которые в его заголовке обозначаются полем "Data")

##### Information Request Tag
| Тип   | Имя           | Значение                   | Описание    |
|-------|---------------|----------------------------|-------------|
| u16   | Type          | 1                          | Тип тега Information Request Tag   |
| u32[] | mbi_tag_types |  (массив u32)              | Массив u32 информационных запросов к загрузчику, если установлен флаг optional может быть пропущен определенный элемент.  |

---
##### Multiboot2 Address Tag
| Тип   | Имя           | Значение                   | Описание    |
|-------|---------------|----------------------------|-------------|
| u16   | Type          | 2                          | Тип тега Multiboot2 Address Tag   |
| u32 | header_addr |  (физический u32 адресс)              | ниже... |
| u32 | load_addr |  (физический u32 адресс)              |   |
| u32 | load_end_addr |  (физический u32 адресс)              |   |
| u32 | bss_end_addr |  (физический u32 адресс)              |   |

> ###### header_addr
> Содержит адрес, соответствующий началу заголовка Multiboot2, — область физической памяти, в которую должно быть загружено магическое значение. Это поле служит для синхронизации сопоставления смещений образа ОС и адресов физической памяти.
>
> ###### load_addr
> Содержит физический адрес начала текстового сегмента. Смещение в файле образа ОС, с которого начинается загрузка, определяется смещением, при котором был найден заголовок, минус (header_addr - load_addr). Значение load_addr должно быть меньше или равно header_addr.
> Специальное значение -1 означает, что файл должен быть загружен с самого начала.
> 
> ###### load_end_addr
> Содержит физический адрес конца сегмента данных. (load_end_addr - load_addr) указывает, какой объём данных необходимо загрузить. Это означает, что сегменты текста и данных должны следовать друг за другом в образе ОС; это верно для существующих форматов исполняемых файлов a.out. Если это поле равно нулю, загрузчик предполагает, что сегменты текста и данных занимают весь файл образа ОС.
> ###### bss_end_addr
> Содержит физический адрес конца сегмента bss. Загрузчик инициализирует эту область нулями и резервирует занимаемую ею память, чтобы не размещать в этой области загрузочные модули и другие данные, относящиеся к операционной системе. Если это поле равно нулю, загрузчик предполагает, что сегмент bss отсутствует.


---
##### Multiboot2 Entry Address Tag
| Тип   | Имя           | Значение                   | Описание    |
|-------|---------------|----------------------------|-------------|
| u16   | Type          | 3                          | Тип тега Multiboot2 Entry Address Tag |
| u32 | entry_addr |  (физический u32 адресс)              | "Физический адрес, по которому должен перейти загрузчик, чтобы запустить операционную систему" |

---
##### Flags Tag
| Тип   | Имя           | Значение                   | Описание    |
|-------|---------------|----------------------------|-------------|
| u16   | Type          | 4                          | Multiboot2 Entry Address Tag |
| u32 | console_flags |  (побитовые флаги)              | "Если этот тег присутствует и бит 0 в «console_flags» установлен, значит, должна присутствовать хотя бы одна из поддерживаемых консолей, и информация о ней должна быть доступна в mbi. Если бит «1» в «console_flags» установлен, это означает, что образ ОС поддерживает текст EGA. " |


---
##### Framebuffer Tag
| Тип | Имя           | Значение                   | Описание    |
|-----|---------------|----------------------------|-------------|
| u16 | Type          | 5                          | Тип тега  Framebuffer Tag  |
| u32 | Size          | 20                         | Размер тега |
| u32 | Width         | (ширина)                   | Содержит количество столбцов. В графическом режиме указывается в пикселях, в текстовом — в символах |
| u32 | Height        | (высота)                   | Содержит количество строк. В графическом режиме указывается в пикселях, в текстовом — в символах |
| u32 | depth         | (глубина)                  | Содержит количество бит на пиксель в графическом режиме и ноль в текстовом режиме |

Значение ноль указывает на то, что образ ОС не имеет предпочтений.

---
#####  
| Тип | Имя           | Значение                   | Описание    |
|-----|---------------|----------------------------|-------------|
| u16 | Type          | 6                          | Тип тега Module Alligment Tag   |
| u32 | Size          | 8                          | Размер тега |

---
##### EFI Boot Services Tag
| Тип | Имя           | Значение                   | Описание    |
|-----|---------------|----------------------------|-------------|
| u16 | Type          | 7                          | Тип тега EFI Boot Services Tag   |
| u32 | Size          | 8                          | Размер тега |

---
##### Multiboot2 EFI i386 Entry Address Tag
| Тип   | Имя           | Значение                   | Описание    |
|-------|---------------|----------------------------|-------------|
| u16   | Type          | 8                          | Тип тега Multiboot2 EFI i386 Entry Address Tag  |
| u32 | entry_addr |  (физический u32 адресс)              | "Физический адрес, по которому должен перейти загрузчик, чтобы начать выполнение кода операционной системы, совместимого с EFI i386" |


---
##### Multiboot2 EFI amd64 Entry Address Tag
| Тип   | Имя           | Значение                   | Описание    |
|-------|---------------|----------------------------|-------------|
| u16   | Type          | 9                          | Тип тега Multiboot2 EFI amd64 Entry Address Tag |
| u32 | entry_addr |  (физический u32 адресс)              | "Физический адрес, по которому должен перейти загрузчик, чтобы начать выполнение кода операционной системы, совместимого с EFI amd64" |


---
##### Relocatable Tag
| Тип | Имя           | Значение                   | Описание    |
|-----|---------------|----------------------------|-------------|
| u16 | Type          | 10                         | Тип тега Relocatable Tag   |
| u32 | Size          | 24                         | Размер тега |
| u32 | min_addr      | 24                         | Наименьший возможный физический адрес, по которому должно загружаться изображение |
| u32 | max_addr      | 24                         | Максимально возможный физический адрес, на котором должно заканчиваться загруженное изображение |
| u32 | align         | 24                         | Выравнивание изображения в памяти |
| u32 | preference    | 24                         | "Содержит предложение по расположению адреса загрузки для загрузчика. Загрузчик должен следовать этому предложению. «0» означает «ничего», «1» означает «загрузить образ по минимально возможному адресу, но не ниже min_addr», а «2» означает «загрузить образ по максимально возможному адресу, но не выше max_addr»" |


---
##### End Tag
| Тип | Имя           | Значение                   | Описание    |
|-----|---------------|----------------------------|-------------|
| u16 | Type          | 0                          | Тип тега  End Tag  |
| u32 | Size          | 8                          | Размер тега |

---
## Ресурсы
[Официальная документация GNU GRUB](https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html)
